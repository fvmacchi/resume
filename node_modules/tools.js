var Sequelize = require('sequelize');
var crypto = require('crypto');
var fs = require('fs');

var sequelize = new Sequelize('resume', 'root', 'password');

//Sequelize Model definitions
var Resume = sequelize.define('resume', {
  id: {
    primaryKey: true,
    type: Sequelize.STRING
  },
  title: Sequelize.STRING,
  skills: Sequelize.TEXT
});

var ResumeSkill = sequelize.define('resumeSkill', {
  id: {
    primaryKey: true,
    type: Sequelize.STRING
  },
  title: Sequelize.STRING,
  description: Sequelize.TEXT
});

var Company = sequelize.define('company', {
	id: {
		primaryKey: true,
		type: Sequelize.STRING
	},
	name: Sequelize.STRING
});

sequelize.sync();

exports.getResume = function(type, callback) {
	Resume.find({where: {id:type}}).success(function(resume) {
		var fetchedSkills = function() {
			callback(resume);
		};
		var skills = JSON.parse(resume.skills);
		if(skills.length == 0) {
			resume.skills = [];
			fetchedSkills();
		}
		else {
			var query = "SELECT * FROM resumeSkills where";
			for(var i = 0; i < skills.length; i++) {
				query += " id='" + skills[i] + "'"
				if(i != skills.length - 1) {
					query += " OR ";
				}
			}
			sequelize.query(query).success(function(skillRows) {
				resume.skills = skillRows;
				fetchedSkills();
			});
		}
	});
};

exports.getCompany = function(id, callback) {
	Company.find({where: {id: id}}).success(callback);
};