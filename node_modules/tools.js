var Sequelize = require('sequelize');
var crypto = require('crypto');
var fs = require('fs');

var sequelize = new Sequelize('resume', 'root', 'glass123');

//Sequelize Model definitions
var Resume = sequelize.define('resume', {
  id: {
    primaryKey: true,
    type: Sequelize.STRING
  },
  title: Sequelize.STRING,
  skills: Sequelize.TEXT
});

var ResumeSkill = sequelize.define('resumeSkill', {
  id: {
    primaryKey: true,
    type: Sequelize.STRING
  },
  title: Sequelize.STRING,
  description: Sequelize.TEXT
});

var Company = sequelize.define('company', {
	id: {
		primaryKey: true,
		type: Sequelize.STRING
	},
	name: Sequelize.STRING
});

sequelize.sync();

var companies = [
{
	name: "2G Robotics"
},
{
	name: "Aeryon Labs"
},
{
	name: "Airware"
},
{
	name: "Bionym"
},
{
	name: "Boltmade"
},
{
	name: "Brock Solutions"
},
{
	name: "Christie Digital"
},
{
	name: "Cisco"
},
{
	name: "Dejero Labs"
},
{
	name: "Enflick"
},
{
	name: "Kik"
},
{
	name: "LinkedIn"
},
{
	name: "Lumotune"
},
{
	name: "NVIDIA"
},
{
	name: "Nest Labs"
},
{
	name: "ON Semiconductor"
},
{
	name: "Palette"
},
{
	name: "Pebble"
},
{
	name: "Pinterest"
},
{
	name: "SandVine"
},
{
	name: "Snapchat"
},
{
	name: "Thalmic Labs"
},
{
	name: "Twitter"
},
{
	name: "blueRover"
},
{
	name: "Google"
},
{
	name: "Tesla Motors"
},
{
	name: "Apple"
}
];

/*
var companyPairings = "";
var createCompany = function(i) {
	if(i < companies.length) {
		var hash = crypto.createHash('sha1');
		hash.update("futuretempglass94" + companies[i].name);
		var id = hash.digest('hex');
		companies[i].id = id;
		companyPairings += id + " : " + companies[i].name + "\n";
		return Company.create(companies[i]).success(function() {
			createCompany(i + 1);
		});
	}
	fs.writeFile('companies.txt', companyPairings, function(){});
};
createCompany(0);
*/

exports.getResume = function(type, callback) {
	Resume.find({where: {id:type}}).success(function(resume) {
		var fetchedSkills = function() {
			callback(resume);
		};
		var skills = JSON.parse(resume.skills);
		if(skills.length == 0) {
			resume.skills = [];
			fetchedSkills();
		}
		else {
			var query = "SELECT * FROM resumeSkills where";
			for(var i = 0; i < skills.length; i++) {
				query += " id='" + skills[i] + "'"
				if(i != skills.length - 1) {
					query += " OR ";
				}
			}
			sequelize.query(query).success(function(skillRows) {
				resume.skills = skillRows;
				fetchedSkills();
			});
		}
	});
};

exports.getCompany = function(id, callback) {
	Company.find({where: {id: id}}).success(callback);
};